name: Troubleshoot WordPress Application (Manual trigger) 

on:
  workflow_dispatch:
    inputs:
      get_plugins:
        description: 'List plugins'
        required: false
        default: true
        type: boolean
      get_repo_secrets: 
        description: 'List repository secrets'
        required: false
        default: true
        type: boolean
      cleanup_docker:   
        description: 'Cleanup Docker environment'
        required: false
        default: true
        type: boolean
      configure_app:
        description: 'Configure application'
        required: false
        default: true
        type: boolean
      check_containers:
        description: 'Check if required containers are running'
        required: false
        default: true
        type: boolean
      validate_app:
        description: 'Validate application'
        required: false
        default: true
        type: boolean

jobs:
  list-wp-plugins:
    runs-on: self-hosted
    if: github.event.inputs.get_plugins == 'true'
    steps:
      - name: List WordPress plugins
        run: | 
            if docker ps | grep -q wordpress; then
              docker exec wordpress /bin/bash -c "wp plugin list --allow-root --path=/var/www/html"
            else
              echo "WordPress container not running"
              exit 1
            fi
  get-repo-secrets:
    if: github.event.inputs.get_repo_secrets == 'true'
    runs-on: self-hosted
    steps:
      - run: | 
          echo "WordPress Admin User: $WORDPRESS_ADMIN_USER"
          echo "WordPress Admin Password: $WORDPRESS_ADMIN_PASSWORD"
          echo "WordPress DB Name: $WORDPRESS_DB_NAME"
          echo "WordPress DB User: $WORDPRESS_DB_USER"
          echo "WordPress DB Password: $WORDPRESS_DB_PASSWORD"
  cleanup-docker:
    if: github.event.inputs.cleanup_docker == 'true'
    uses: ./.github/workflows/environment_docker_cleanup.yml
  configure-app:
    if: github.event.inputs.configure_app == 'true'
    uses: ./.github/workflows/app_configure.yml
  check-containers:
    if: github.event.inputs.check_containers == 'true'
    runs-on: self-hosted
    steps:
      - name: Check if containers are running
        run: |
          required_containers=(db wordpress https)
          missing=0
          for c in "${required_containers[@]}"; do
            if ! docker ps --format '{{.Names}}' | grep -qw "$c"; then
              echo "Container $c is NOT running."
              missing=1
            else
              echo "Container $c is running."
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "One or more required containers are not running."
            exit 1
          fi
  validate-app:
    if: github.event.inputs.validate_app == 'true'
    uses: ./.github/workflows/app_validate.yml