name: Run Application

on:
  workflow_call:  

jobs:
  start-containers:
    runs-on: [self-hosted]
    steps:
      - name: Start WordPress Containers
        uses: nick-fields/retry@v3
        #https://github.com/marketplace/actions/retry-step
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_on: error
          command: docker compose --env-file .env -f webapp/docker-compose.yml up -d
  setup-configurations:
    needs: start-containers
    runs-on: [self-hosted]
    steps:
      - name: Move Nginx configuration files to proper directory after container started
        # This step is necessary to the server to handle HTTPS using mkcert.
        run: |
          docker exec https /bin/bash -c "mv /etc/nginx/nginx-config/*.conf /etc/nginx/conf.d/"
          docker exec https /bin/bash -c "service nginx reload"
      - name: Copy wordpress configuration files to container
        run: |
          docker exec wordpress /bin/bash -c "chmod +x /var/www/wordpress-config/*.sh"
  configure-wordpress:
    needs: setup-configurations
    uses: ./.github/workflows/app_configure_wordpress.yml