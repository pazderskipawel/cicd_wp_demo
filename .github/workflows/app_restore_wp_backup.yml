name: Restore latest saved wordpress state from artifacts (Manual trigger)
on:
  workflow_dispatch:
  workflow_call:
    inputs:
      run_id:
        description: 'The run ID of the workflow that created the backup artifact'
        required: true
        type: string

jobs:
  download-wordpress-backup:
    runs-on: self-hosted
    steps: 
      - name: Create restore directory - temporary for testing
        run: |
          echo "Creating restore directory"
          mkdir -p ./wp-restored
      - name: Download artifact from last successful run
        run: |
          gh run download ${{ inputs.run_id }} -n wordpress-backup -D ./wp-restored/
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  restore-wordpress-state-from-backup:
    runs-on: self-hosted
    needs: download-wordpress-backup
    steps:
      - name: Restore WordPress state from backup
        run: |
          echo "Restoring WordPress state from backup"
          docker cp ./wp-restored/. wordpress:/var/www/html/
          echo "WordPress state restored successfully from backup"
      - name: Restore database from backup
        run: |
          echo "Restoring database from backup"
          docker exec wordpress wp db import ./wp-restored/wordpress-database.sql --allow-root --path=/var/www/html
          echo "Database restored successfully from backup"
  
  remove-backup-directory:
    runs-on: self-hosted
    needs: restore-wordpress-state-from-backup
    steps:
      - name: Remove temporary backup directory
        run: |
          echo "Removing temporary backup directory"
          rm -rf ./wp-restored
          echo "Temporary backup directory removed successfully"